<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Presen√ßa</title>
    <style>
        /* --- ESTILO GERAL --- */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; display: flex; justify-content: center; padding: 10px; margin: 0; }
        .container { background: white; padding: 0; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 600px; overflow: hidden; position: relative; }
        
        /* CABE√áALHO */
        header { background-color: #fff; padding: 20px 20px 0 20px; }
        h2 { text-align: center; color: #444; margin: 0 0 10px 0; }
        #status { font-size: 12px; color: #888; text-align: center; margin-bottom: 15px; display: block;}

        /* --- ABAS (TABS) --- */
        .tabs { display: flex; border-bottom: 1px solid #ddd; background: #f8f9fa; }
        .tab-btn {
            flex: 1; padding: 15px 5px; border: none; background: none; font-weight: bold; color: #666; cursor: pointer; border-bottom: 3px solid transparent; transition: 0.3s; font-size: 14px;
        }
        .tab-btn.active { color: #007bff; border-bottom: 3px solid #007bff; background: #fff; }
        
        .tab-content { display: none; padding: 15px; }
        .tab-content.active { display: block; }

        /* --- FORMUL√ÅRIO GERAL --- */
        .form-group { background-color: #f1f3f5; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        input[type="text"], input[type="tel"] { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        
        button.btn-add { width: 100%; padding: 12px; border: none; border-radius: 6px; cursor: pointer; color: white; font-weight: bold; background-color: #28a745; }
        button.btn-report { width: 100%; padding: 12px; border: none; border-radius: 6px; cursor: pointer; color: white; background-color: #217346; margin-top: 20px; font-weight: bold;}
        
        /* --- LISTAS --- */
        ul { list-style-type: none; padding: 0; margin: 0; }
        li { background: #fff; border-bottom: 1px solid #eee; padding: 15px 0; display: flex; justify-content: space-between; align-items: center; }
        
        .info-pessoa { display: flex; flex-direction: column; flex: 1; padding-right: 10px;}
        .nome-convidado { font-weight: bold; font-size: 16px; color: #333; margin-bottom: 4px; }
        
        .linha-detalhes { display: flex; align-items: center; flex-wrap: wrap; gap: 6px; font-size: 12px; color: #666; }
        
        .badge { padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 11px; border: 1px solid #dee2e6; display: inline-block;}
        .badge-ga { background-color: #e9ecef; color: #495057; }
        .badge-tel { background-color: #e3f2fd; color: #0d6efd; border-color: #b6d4fe; }

        .acoes-btn { display: flex; gap: 8px; align-items: center; }

        .btn-check, .btn-edit {
            width: 38px; height: 38px; min-width: 38px;
            border-radius: 50%; border: 2px solid #ddd;
            background: white; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 18px; transition: 0.2s;
        }
        .btn-edit { border-color: #ffc107; color: #d39e00; font-size: 16px; } 
        .btn-undo { border-color: #dc3545; color: #dc3545; }
        .btn-check-green { border-color: #28a745; color: #28a745; }
        
        /* --- MODAL (JANELA DE EDI√á√ÉO) --- */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center;
        }
        .modal-content {
            background-color: white; padding: 20px; border-radius: 12px;
            width: 90%; max-width: 400px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            animation: fadeIn 0.3s;
        }
        .modal-buttons { display: flex; gap: 10px; margin-top: 15px; }
        .btn-cancel { background-color: #6c757d; color: white; flex: 1; padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;}
        .btn-save { background-color: #007bff; color: white; flex: 1; padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;}

        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

    </style>
</head>
<body>

<div class="container">
    <header>
        <h2>Lista de Presen√ßa</h2>
        <div id="status">üîå Conectando...</div>
        <input type="text" id="pesquisa" placeholder="üîç Buscar Nome, Respons√°vel ou G.A." onkeyup="renderizarTodasListas()">
    </header>

    <div class="tabs">
        <button class="tab-btn active" onclick="abrirAba('abaPendentes')" id="btnPendentes">Convidados (0)</button>
        <button class="tab-btn" onclick="abrirAba('abaPresentes')" id="btnPresentes">Presentes Confirmados (0)</button>
        <button class="tab-btn" onclick="abrirAba('abaCadastro')">+ Novo</button>
    </div>

    <div id="abaPendentes" class="tab-content active">
        <ul id="listaPendentes"></ul>
    </div>

    <div id="abaPresentes" class="tab-content">
        <ul id="listaPresentes"></ul>
        <button class="btn-report" onclick="gerarRelatorioExcel()">üìä Baixar Excel (.xlsx)</button>
    </div>

    <div id="abaCadastro" class="tab-content">
        <div class="form-group">
            <h3>Cadastrar Novo (J√° confirmado)</h3>
            <input type="text" id="novoResponsavel" placeholder="Membro Respons√°vel">
            <input type="text" id="novoNome" placeholder="Nome do Convidado *">
            <input type="tel" id="novoTelefone" placeholder="Telefone">
            <input type="text" id="novoGA" placeholder="G.A.">
            <button class="btn-add" onclick="adicionarPessoaPresente()">‚úÖ Cadastrar e Confirmar</button>
        </div>
    </div>
</div>

<div id="modalEditar" class="modal">
    <div class="modal-content">
        <h3 style="margin-top:0; color:#333">‚úèÔ∏è Editar Convidado</h3>
        <input type="hidden" id="editId"> 
        <label style="font-size:12px; color:#666">Nome do Convidado</label>
        <input type="text" id="editNome">
        <label style="font-size:12px; color:#666">Respons√°vel</label>
        <input type="text" id="editResponsavel">
        <label style="font-size:12px; color:#666">Telefone</label>
        <input type="tel" id="editTelefone">
        <label style="font-size:12px; color:#666">G.A.</label>
        <input type="text" id="editGA">
        <div class="modal-buttons">
            <button class="btn-cancel" onclick="fecharModal()">Cancelar</button>
            <button class="btn-save" onclick="salvarEdicao()">Salvar Altera√ß√µes</button>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

<script>
    // --- 1. CONFIGURA√á√ÉO ---
    const firebaseConfig = {
        apiKey: "AIzaSyAtNQFGCNwZuY633XknHJYGrEPsvbPU-rs",
        authDomain: "listapresencaapp-a80df.firebaseapp.com",
        databaseURL: "https://listapresencaapp-a80df-default-rtdb.firebaseio.com",
        projectId: "listapresencaapp-a80df",
        storageBucket: "listapresencaapp-a80df.firebasestorage.app",
        messagingSenderId: "391717293906",
        appId: "1:391717293906:web:60f6a3f5213f4cf631f48b"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    let listaLocal = [];

    // --- 2. ESCUTAR DADOS ---
    const dbRef = db.ref('convidados'); 
    
    dbRef.on('value', (snapshot) => {
        document.getElementById('status').innerText = "üü¢ Sistema Online";
        listaLocal = [];
        
        if (snapshot.exists()) {
            snapshot.forEach((childSnapshot) => {
                let dados = childSnapshot.val();
                
                // --- CORRE√á√ÉO AQUI ---
                // Verifica se est√° escrito 'telefone' OU 'Telefone' OU 'celular' (por precau√ß√£o)
                let telefoneEncontrado = dados.telefone || dados.Telefone || dados.celular || dados.Celular || "";
                
                // Mesma verifica√ß√£o para os outros campos, por garantia
                let nomeEncontrado = dados.nome || dados.Nome || "Sem Nome";
                let responsavelEncontrado = dados.responsavel || dados.Responsavel || dados.Respons√°vel || "-";
                let gaEncontrado = dados.ga || dados.GA || dados.Ga || "-";

                listaLocal.push({
                    id: childSnapshot.key,
                    nome: nomeEncontrado,
                    responsavel: responsavelEncontrado,
                    telefone: telefoneEncontrado,
                    ga: gaEncontrado,
                    presente: dados.presente || false
                });
            });
        }
        
        listaLocal.sort((a, b) => a.nome.localeCompare(b.nome));
        renderizarTodasListas();

    }, (error) => {
        document.getElementById('status').innerText = "üî¥ Erro de Conex√£o";
    });

    // --- 3. RENDERIZAR LISTAS ---
    function renderizarTodasListas() {
        let ulPendentes = document.getElementById('listaPendentes');
        let ulPresentes = document.getElementById('listaPresentes');
        let filtro = document.getElementById('pesquisa').value.toLowerCase();

        ulPendentes.innerHTML = "";
        ulPresentes.innerHTML = "";

        let contadorPendentes = 0;
        let contadorPresentes = 0;

        listaLocal.forEach((pessoa) => {
            let textoBusca = (pessoa.nome + " " + pessoa.responsavel + " " + pessoa.ga).toLowerCase();
            if (filtro && !textoBusca.includes(filtro)) return; 

            let li = document.createElement('li');
            
            // Renderiza o telefone se existir
            let htmlTelefone = "";
            if(pessoa.telefone && pessoa.telefone !== "") {
                htmlTelefone = `<span class="badge badge-tel">üìû ${pessoa.telefone}</span>`;
            }

            let htmlGA = "";
            if(pessoa.ga && pessoa.ga !== "-" && pessoa.ga !== "") {
                htmlGA = `<span class="badge badge-ga">GA: ${pessoa.ga}</span>`;
            }

            let infoHtml = `
                <div class="info-pessoa">
                    <span class="nome-convidado">${pessoa.nome}</span>
                    <div class="linha-detalhes">
                        <span>Resp: ${pessoa.responsavel}</span>
                        ${htmlGA}
                        ${htmlTelefone}
                    </div>
                </div>
            `;

            let botoesHtml = "";
            if (pessoa.presente) {
                contadorPresentes++;
                botoesHtml = `
                    <div class="acoes-btn">
                        <button class="btn-edit" onclick="abrirModalEdicao('${pessoa.id}')">‚úèÔ∏è</button>
                        <button class="btn-check btn-undo" onclick="alterarPresenca('${pessoa.id}', true)">‚Ü©Ô∏è</button>
                    </div>
                `;
                li.innerHTML = infoHtml + botoesHtml;
                ulPresentes.appendChild(li);
            } else {
                contadorPendentes++;
                botoesHtml = `
                    <div class="acoes-btn">
                        <button class="btn-edit" onclick="abrirModalEdicao('${pessoa.id}')">‚úèÔ∏è</button>
                        <button class="btn-check btn-check-green" onclick="alterarPresenca('${pessoa.id}', false)">‚úî</button>
                    </div>
                `;
                li.innerHTML = infoHtml + botoesHtml;
                ulPendentes.appendChild(li);
            }
        });

        document.getElementById('btnPendentes').innerText = `Convidados (${contadorPendentes})`;
        document.getElementById('btnPresentes').innerText = `Presentes Confirmados (${contadorPresentes})`;

        if(ulPendentes.innerHTML === "") ulPendentes.innerHTML = '<p style="text-align:center; color:#ccc">Vazio.</p>';
        if(ulPresentes.innerHTML === "") ulPresentes.innerHTML = '<p style="text-align:center; color:#ccc">Vazio.</p>';
    }

    // --- FUN√á√ïES DE L√ìGICA ---
    function alterarPresenca(id, statusAtual) {
        db.ref('convidados/' + id).update({ presente: !statusAtual });
    }

    function adicionarPessoaPresente() {
        let responsavel = document.getElementById('novoResponsavel').value.trim();
        let nome = document.getElementById('novoNome').value.trim();
        let telefone = document.getElementById('novoTelefone').value.trim();
        let ga = document.getElementById('novoGA').value.trim();

        if (nome === "") { alert("Nome obrigat√≥rio!"); return; }

        dbRef.push({
            responsavel: responsavel, nome: nome, telefone: telefone, ga: ga, presente: true 
        });

        document.getElementById('novoNome').value = "";
        document.getElementById('novoTelefone').value = "";
        alert("Cadastrado!");
        abrirAba('abaPresentes'); 
    }

    function abrirAba(nomeAba) {
        let conteudos = document.getElementsByClassName('tab-content');
        for (let i = 0; i < conteudos.length; i++) {
            conteudos[i].style.display = "none";
            conteudos[i].classList.remove('active');
        }
        let botoes = document.getElementsByClassName('tab-btn');
        for (let i = 0; i < botoes.length; i++) {
            botoes[i].classList.remove('active');
        }
        document.getElementById(nomeAba).style.display = "block";
        document.getElementById(nomeAba).classList.add('active');
        if(nomeAba === 'abaPendentes') document.getElementById('btnPendentes').classList.add('active');
        if(nomeAba === 'abaPresentes') document.getElementById('btnPresentes').classList.add('active');
        if(nomeAba === 'abaCadastro') botoes[2].classList.add('active');
    }

    // --- EDITAR ---
    function abrirModalEdicao(id) {
        let pessoa = listaLocal.find(p => p.id === id);
        if (pessoa) {
            document.getElementById('editId').value = id;
            document.getElementById('editNome').value = pessoa.nome;
            document.getElementById('editResponsavel').value = pessoa.responsavel;
            document.getElementById('editTelefone').value = pessoa.telefone;
            document.getElementById('editGA').value = pessoa.ga === "-" ? "" : pessoa.ga;
            document.getElementById('modalEditar').style.display = "flex";
        }
    }
    function fecharModal() {
        document.getElementById('modalEditar').style.display = "none";
    }
    function salvarEdicao() {
        let id = document.getElementById('editId').value;
        let nome = document.getElementById('editNome').value;
        let responsavel = document.getElementById('editResponsavel').value;
        let telefone = document.getElementById('editTelefone').value;
        let ga = document.getElementById('editGA').value;
        if(nome.trim() === "") { alert("Nome obrigat√≥rio."); return; }

        // Salva tudo min√∫sculo para padronizar daqui pra frente
        db.ref('convidados/' + id).update({
            nome: nome, responsavel: responsavel, telefone: telefone, ga: ga
        }, (error) => {
            if (!error) fecharModal();
        });
    }
    window.onclick = function(event) {
        if (event.target == document.getElementById('modalEditar')) fecharModal();
    }

    function gerarRelatorioExcel() {
        let dadosParaExcel = listaLocal.map(p => ({
            "Nome do Convidado": p.nome, "Respons√°vel": p.responsavel, "G.A.": p.ga, "Telefone": p.telefone, "Status": p.presente ? "Confirmado" : "Pendente"
        }));
        const ws = XLSX.utils.json_to_sheet(dadosParaExcel);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Lista de Igreja");
        XLSX.writeFile(wb, "Relatorio_Presenca.xlsx");
    }
</script>

</body>
</html>