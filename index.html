<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Convidados</title>
    <style>
        /* --- ESTILO GERAL --- */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; display: flex; justify-content: center; padding: 10px; margin: 0; }
        .container { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 600px; }
        
        h2 { text-align: center; color: #444; margin-bottom: 5px; }
        #status { font-size: 12px; color: #888; text-align: center; margin-bottom: 15px; }

        /* --- √ÅREA DE CADASTRO --- */
        .form-group {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            margin-bottom: 20px;
        }
        .form-group h3 { margin-top: 0; font-size: 16px; color: #555; }
        
        input[type="text"], input[type="tel"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-sizing: border-box; 
        }
        
        button { width: 100%; padding: 12px; border: none; border-radius: 6px; cursor: pointer; color: white; font-weight: bold; font-size: 16px; transition: 0.3s; }
        .btn-add { background-color: #28a745; }
        .btn-add:hover { background-color: #218838; }
        .btn-report { background-color: #007bff; margin-top: 15px;}
        
        /* --- LISTA --- */
        ul { list-style-type: none; padding: 0; }
        li {
            background: #fff;
            border-bottom: 1px solid #eee;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        li.presente { background-color: #d1e7dd; border-left: 5px solid #198754; }
        
        .info-pessoa { display: flex; flex-direction: column; }
        .nome-convidado { font-weight: bold; font-size: 16px; }
        .detalhes-convidado { font-size: 12px; color: #666; margin-top: 2px; }
        
        /* Checkbox grande para facilitar no celular */
        input[type="checkbox"] { transform: scale(1.5); margin-left: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h2>üìã Lista de Convidados</h2>
    <div id="status">üîå Conectando...</div>

    <div class="form-group">
        <h3>Cadastrar Nova Presen√ßa</h3>
        <input type="text" id="novoResponsavel" placeholder="Membro Respons√°vel">
        <input type="text" id="novoNome" placeholder="Nome do Convidado *">
        <input type="tel" id="novoTelefone" placeholder="Telefone">
        <input type="text" id="novoGA" placeholder="G.A.">
        <button class="btn-add" onclick="adicionarPessoaPresente()">‚úÖ Cadastrar e Marcar Presen√ßa</button>
    </div>

    <hr>

    <input type="text" id="pesquisa" placeholder="üîç Pesquisar convidado..." onkeyup="renderizarLista()" style="width: 100%; margin-bottom: 10px;">

    <ul id="listaNomes">
        <p style="text-align:center; color:#999">Aguardando dados...</p>
    </ul>

    <button class="btn-report" onclick="gerarRelatorio()">üì• Baixar Relat√≥rio Completo</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
    // --- 1. CONFIGURA√á√ÉO COM TUAS CHAVES ---
    const firebaseConfig = {
        apiKey: "AIzaSyAtNQFGCNwZuY633XknHJYGrEPsvbPU-rs",
        authDomain: "listapresencaapp-a80df.firebaseapp.com",
        databaseURL: "https://listapresencaapp-a80df-default-rtdb.firebaseio.com",
        projectId: "listapresencaapp-a80df",
        storageBucket: "listapresencaapp-a80df.firebasestorage.app",
        messagingSenderId: "391717293906",
        appId: "1:391717293906:web:60f6a3f5213f4cf631f48b"
    };

    // Inicializa o Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    // Lista local para manipularmos os dados antes de desenhar na tela
    let listaLocal = [];

    // --- 2. ESCUTAR DADOS DO BANCO ---
    // Estamos a olhar para a pasta 'convidados'
    const dbRef = db.ref('convidados'); 
    
    dbRef.on('value', (snapshot) => {
        document.getElementById('status').innerText = "üü¢ Sistema Online";
        listaLocal = [];
        
        // Se houver dados, processamos cada um
        if (snapshot.exists()) {
            snapshot.forEach((childSnapshot) => {
                let dados = childSnapshot.val();
                // Monta o objeto com prote√ß√µes para evitar erros se faltar algum campo
                listaLocal.push({
                    id: childSnapshot.key,
                    nome: dados.nome || "Sem Nome",
                    responsavel: dados.responsavel || "-",
                    telefone: dados.telefone || "-",
                    ga: dados.ga || "-",
                    presente: dados.presente || false
                });
            });
        } else {
            document.getElementById('listaNomes').innerHTML = '<p style="text-align:center">Nenhum convidado na lista ainda.</p>';
            return;
        }

        // Ordenar alfabeticamente pelo nome do convidado
        listaLocal.sort((a, b) => a.nome.localeCompare(b.nome));

        renderizarLista();
    }, (error) => {
        console.error(error);
        document.getElementById('status').innerText = "üî¥ Erro de Permiss√£o ou Conex√£o";
    });

    // --- 3. ADICIONAR (J√Å COMO PRESENTE) ---
    function adicionarPessoaPresente() {
        let responsavel = document.getElementById('novoResponsavel').value.trim();
        let nome = document.getElementById('novoNome').value.trim();
        let telefone = document.getElementById('novoTelefone').value.trim();
        let ga = document.getElementById('novoGA').value.trim();

        if (nome === "") {
            alert("O nome do convidado √© obrigat√≥rio!");
            return;
        }

        // Envia para o Firebase
        dbRef.push({
            responsavel: responsavel,
            nome: nome,
            telefone: telefone,
            ga: ga,
            presente: true 
        });

        // Limpa os campos
        document.getElementById('novoResponsavel').value = "";
        document.getElementById('novoNome').value = "";
        document.getElementById('novoTelefone').value = "";
        document.getElementById('novoGA').value = "";
        alert("Cadastrado com sucesso!");
    }

    // --- 4. RENDERIZAR LISTA NA TELA ---
    function renderizarLista() {
        let ul = document.getElementById('listaNomes');
        let filtro = document.getElementById('pesquisa').value.toLowerCase();
        
        // Se a lista estiver vazia (mas carregada), n√£o limpa tudo violentamente
        if(listaLocal.length > 0) ul.innerHTML = ""; 

        let encontrouAlguem = false;

        listaLocal.forEach((pessoa) => {
            // Filtro de pesquisa
            if (filtro && !pessoa.nome.toLowerCase().includes(filtro)) {
                return;
            }
            encontrouAlguem = true;

            let li = document.createElement('li');
            if (pessoa.presente) li.classList.add('presente');

            li.innerHTML = `
                <div class="info-pessoa">
                    <span class="nome-convidado">${pessoa.nome}</span>
                    <span class="detalhes-convidado">Resp: ${pessoa.responsavel} | GA: ${pessoa.ga}</span>
                </div>
                <input type="checkbox" ${pessoa.presente ? "checked" : ""} 
                 onchange="alterarPresenca('${pessoa.id}', ${pessoa.presente})">
            `;
            ul.appendChild(li);
        });
        
        if (!encontrouAlguem && filtro !== "") {
             ul.innerHTML = '<p style="text-align:center">Ningu√©m encontrado com esse nome.</p>';
        }
    }

    // --- 5. ALTERAR PRESEN√áA (CHECKBOX) ---
    function alterarPresenca(id, statusAtual) {
        // Atualiza apenas o campo 'presente' daquele ID espec√≠fico
        db.ref('convidados/' + id).update({
            presente: !statusAtual
        });
    }

    // --- 6. GERAR RELAT√ìRIO CSV ---
    function gerarRelatorio() {
        let conteudoCSV = "Convidado,Responsavel,Telefone,GA,Status\n"; 
        listaLocal.forEach(p => {
            let status = p.presente ? "Presente" : "Ausente";
            // Tratamento simples para evitar erros se tiver v√≠rgula no nome
            let nomeLimpo = p.nome.replace(/,/g, ""); 
            conteudoCSV += `${nomeLimpo},${p.responsavel},${p.telefone},${p.ga},${status}\n`;
        });

        let blob = new Blob([conteudoCSV], { type: 'text/csv;charset=utf-8;' });
        let link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "lista_final.csv";
        link.click();
    }
</script>

</body>
</html>